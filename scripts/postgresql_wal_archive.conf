# M148: PostgreSQL WAL Archive Configuration
# =============================================
#
# This configuration enables Write-Ahead Log (WAL) archiving for
# point-in-time recovery (PITR) and backup purposes.
#
# Add these settings to postgresql.conf or use as a separate include file.
#
# To include this file, add to postgresql.conf:
#   include = 'conf.d/wal_archive.conf'

# =============================================
# WAL Settings
# =============================================

# Set the WAL level to replica for archiving support
wal_level = replica

# Keep at least 10 WAL files before recycling
wal_keep_size = 1GB

# Maximum number of concurrent WAL sender processes
max_wal_senders = 3

# =============================================
# Archive Settings
# =============================================

# Enable WAL archiving
archive_mode = on

# Archive command - copies WAL files to archive directory
# %p = path to the WAL file to archive
# %f = filename of the WAL file
# 
# For Linux/macOS:
# archive_command = 'test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'
#
# For Windows:
# archive_command = 'copy "%p" "C:/PostgreSQL/wal_archive/%f"'
#
# For cloud storage (S3 example):
# archive_command = 'aws s3 cp %p s3://your-bucket/wal-archive/%f'

archive_command = 'test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'

# Archive timeout - force archiving after this many seconds
archive_timeout = 300

# =============================================
# Recovery Settings (for standby servers)
# =============================================

# Restore command for recovery
# restore_command = 'cp /var/lib/postgresql/wal_archive/%f %p'

# =============================================
# Monitoring
# =============================================

# Log archival failures
log_min_messages = warning

# =============================================
# Important Notes
# =============================================
#
# 1. Create the archive directory before enabling:
#    mkdir -p /var/lib/postgresql/wal_archive
#    chown postgres:postgres /var/lib/postgresql/wal_archive
#
# 2. Restart PostgreSQL after changing these settings:
#    sudo systemctl restart postgresql
#
# 3. Verify archiving is working:
#    SELECT * FROM pg_stat_archiver;
#
# 4. Check archive status:
#    SELECT pg_walfile_name(pg_current_wal_lsn());
#
# 5. For production, consider using pg_basebackup for initial backup:
#    pg_basebackup -D /backup/base -Ft -z -P
